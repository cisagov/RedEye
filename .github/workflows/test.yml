name: Cypress Tests

on:
 # manual button click from the GitHub UI
 workflow_dispatch:
 push:
  branches:
   - main
   - develop
 pull_request:
  branches:
   - '**'

jobs:
 prepare:
  runs-on: ubuntu-20.04
  outputs:
   uuid: ${{ steps.uuid.outputs.value }}
  steps:
   - name: Generate unique ID ðŸ’Ž
     id: uuid
     run: echo "{name}={sha-$GITHUB_SHA-time-$(date +"%s")}" >> $GITHUB_ENV

   - name: Print unique ID ðŸ–¨`
     run: echo "generated id ${{ steps.uuid.outputs.value }}"

 install:
  needs: ['prepare']
  runs-on: ubuntu-latest
  steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Cache
     uses: actions/setup-node@v3
     with:
      cache: 'yarn'
   - run: yarn install
   - run: yarn build:all

   - name: Save build folder
     uses: actions/upload-artifact@v3
     with:
      name: dist
      if-no-files-found: error
      path: dist

 RedTeamChrome:
  runs-on: ubuntu-latest
  needs: [prepare, install]
  strategy:
   fail-fast: false

  steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Cache
     uses: actions/setup-node@v3
     with:
      cache: 'yarn'

   - name: Download the build folders
     uses: actions/download-artifact@v3
     with:
      name: dist
      path: dist

   - name: 'Red Team Tests - Chrome'
     uses: cypress-io/github-action@v4
     with:
      start: yarn start
      wait-on: 'http://localhost:4000/api/graphql, http://localhost:3500'
      browser: chrome
      group: 'Red Team - Chrome'
      working-directory: applications/redeye-e2e
      config: baseUrl=http://localhost:3500
      record: true
      parallel: true
      config-file: cypress.config.js
      spec: src/integration/e2e/redteam/**/**/**/*.cy.js
      ci-build-id: ${{ needs.prepare.outputs.uuid }}
     env:
      CYPRESS_PROJECT_ID: 'rsybgk'
      CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY_RED }}

 RedTeamFirefox:
  runs-on: ubuntu-latest
  needs: [prepare, install]
  strategy:
   fail-fast: false

  steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Cache
     uses: actions/setup-node@v3
     with:
      cache: 'yarn'

   - name: Download the build folders
     uses: actions/download-artifact@v3
     with:
      name: dist
      path: dist
      
   - name: Ensure Firefox
     run: |
        sudo snap remove firefox
        sudo add-apt-repository ppa:mozillateam/ppa
        sudo rm -rf /etc/firefox
        echo '
         Package: *
         Pin: release o=LP-PPA-mozillateam
         Pin-Priority: 1001
         ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
        sudo apt install firefox
        which firefox

   - name: 'Red Team Tests - Firefox'
     uses: cypress-io/github-action@v4
     with:
      start: yarn start
      wait-on: 'http://localhost:4000/api/graphql, http://localhost:3500'
      browser: /usr/bin/firefox
      group: 'Red Team - Firefox'
      working-directory: applications/redeye-e2e
      config: baseUrl=http://localhost:3500
      record: true
      parallel: true
      config-file: cypress.config.js
      spec: src/integration/e2e/redteam/**/**/**/*.cy.js
      ci-build-id: ${{ needs.prepare.outputs.uuid }}
     env:
      CYPRESS_PROJECT_ID: 'rsybgk'
      CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY_RED1 }}

 BlueTeamChrome:
  runs-on: ubuntu-latest
  needs: [prepare, install]
  strategy:
   fail-fast: false

  steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Cache
     uses: actions/setup-node@v3
     with:
      cache: 'yarn'

   - name: Download the build folders
     uses: actions/download-artifact@v3
     with:
      name: dist
      path: dist

   - name: 'Blue Team Tests - Chrome'
     uses: cypress-io/github-action@v4
     with:
      start: yarn start:blue
      wait-on: 'http://localhost:4000/api/graphql, http://localhost:3500'
      browser: chrome
      group: 'Blue Team - Chrome'
      working-directory: applications/redeye-e2e
      config: baseUrl=http://localhost:3500
      record: true
      parallel: true
      config-file: cypress.config.js
      spec: src/integration/e2e/blueteam/**/*.cy.js
      ci-build-id: ${{ needs.prepare.outputs.uuid }}
     env:
      CYPRESS_PROJECT_ID: '46ahz3'
      CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY_BLUE }}

 BlueTeamFirefox:
  runs-on: ubuntu-latest
  needs: [prepare, install]
  strategy:
   fail-fast: false

  steps:
   - name: Checkout
     uses: actions/checkout@v3

   - name: Cache
     uses: actions/setup-node@v3
     with:
      cache: 'yarn'

   - name: Download the build folders
     uses: actions/download-artifact@v3
     with:
      name: dist
      path: dist
      
   - name: Ensure Firefox
     run: |
        sudo snap remove firefox
        sudo add-apt-repository ppa:mozillateam/ppa
        sudo rm -rf /etc/firefox
        echo '
         Package: *
         Pin: release o=LP-PPA-mozillateam
         Pin-Priority: 1001
         ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
        sudo apt install firefox
        which firefox

   - name: 'Blue Team Tests - Firefox'
     uses: cypress-io/github-action@v4
     with:
      start: yarn start:blue
      wait-on: 'http://localhost:4000/api/graphql, http://localhost:3500'
      browser: /usr/bin/firefox
      group: 'Blue Team - Firefox'
      working-directory: applications/redeye-e2e
      config: baseUrl=http://localhost:3500
      record: true
      parallel: true
      config-file: cypress.config.js
      spec: src/integration/e2e/blueteam/**/*.cy.js
      ci-build-id: ${{ needs.prepare.outputs.uuid }}
     env:
      CYPRESS_PROJECT_ID: '46ahz3'
      CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY_BLUE1 }}
